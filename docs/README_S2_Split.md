# S2_Split.py 使用说明

## 简介

`S2_Split.py` 是一个专业的FASTQ文件分割工具，用于根据指定的分隔符序列将单个FASTQ文件分割成配对的R1和R2文件。该脚本特别适用于处理包含多重结构的测序数据，如双末端测序数据的重新分割和配对。

## 主要功能

- 🧬 **智能序列分割**：根据两个分隔符序列精确分割FASTQ reads
- 🔄 **反向互补支持**：自动计算并匹配反向互补序列
- 🎯 **多种匹配模式**：支持正向、反向、混合方向匹配
- 👥 **配对保证**：确保输出的R1和R2文件完全配对
- 📏 **长度过滤**：可设置最小序列长度要求
- 📊 **详细统计**：提供全面的处理统计和方向分析
- 🗜️ **压缩文件处理**：直接处理gzip压缩的FASTQ文件

## 应用场景

- **双末端测序数据重组**：将合并的reads重新分割为R1/R2配对
- **条形码序列分离**：从包含barcode的reads中提取目标序列
- **接头序列去除**：基于已知接头序列分割和清理数据
- **多重PCR产物分析**：分离PCR扩增产物中的不同区域

## 系统要求

### Python版本
- Python 3.6 或更高版本

### 依赖库
```bash
# 所有依赖库都是Python标准库，无需额外安装
- argparse
- gzip
- os
- sys
- pathlib
```

## 安装

```bash
# 下载脚本文件
# 确保脚本具有执行权限
chmod +x S2_Split.py
```

## 使用方法

### 基本语法
```bash
python S2_Split.py -i <输入文件> -o <输出目录> [其他选项]
```

### 参数说明

#### 必需参数
| 参数 | 说明 |
|------|------|
| `-i, --input` | **必需**，输入的FASTQ.gz文件路径 |
| `-o, --output` | **必需**，输出目录路径 |

#### 可选参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--sep1` | GATCATGTCGGAACTGTTGCTTGTCCGACTGATC | 第一个分隔符序列 |
| `--sep2` | AGATCGGAAGA | 第二个分隔符序列 |
| `--min-length` | 10 | 分割后序列的最小长度 |

## 工作原理

### 分割逻辑
```
原始read结构: [R1序列] + [分隔符1] + [R2序列] + [分隔符2] + [其他序列]
                ↓
输出结果: R1文件 ← [R1序列]  |  R2文件 ← [R2序列]
```

### 匹配模式
脚本支持四种分隔符匹配模式：

1. **正向匹配**：`sep1_正向 + sep2_正向`
2. **反向匹配**：`sep1_反向互补 + sep2_反向互补`  
3. **混合匹配1**：`sep1_正向 + sep2_反向互补`
4. **混合匹配2**：`sep1_反向互补 + sep2_正向`

### 质量控制
- 自动过滤长度不足的序列片段
- 丢弃无法找到分隔符的reads
- 确保R1和R2严格配对

## 使用示例

### 基础使用
```bash
# 使用默认分隔符处理文件
python S2_Split.py -i sample.fastq.gz -o output_dir
```

### 自定义分隔符
```bash
# 指定自定义的分隔符序列
python S2_Split.py \
    -i sample.fastq.gz \
    -o output_dir \
    --sep1 "ATCGATCGATCG" \
    --sep2 "GCTAGCTAGCTA"
```

### 设置最小长度
```bash
# 要求分割后的序列至少20bp
python S2_Split.py \
    -i sample.fastq.gz \
    -o output_dir \
    --min-length 20
```

### 批量处理
```bash
# 处理多个文件的示例脚本
for file in *.fastq.gz; do
    echo "处理文件: $file"
    python S2_Split.py -i "$file" -o "split_$(basename $file .fastq.gz)" -min-length 20   --sep1 "ATCGATCGATCG"  --sep2 "GCTAGCTAGCTA"
done
```

## 输出说明

### 输出文件
脚本会在指定输出目录下生成三个文件：

| 文件名 | 内容 | 说明 |
|--------|------|------|
| `{basename}_R1.fq.gz` | 第一个序列片段 | 配对的R1 reads |
| `{basename}_R2.fq.gz` | 第二个序列片段 | 配对的R2 reads |
| `{basename}_discarded.fq.gz` | 丢弃的reads | 不符合条件的原始reads |

### 统计输出
```
=== 处理完成统计 ===
总reads数: 100000
成功配对的reads数: 85000
丢弃的reads数: 15000
配对成功率: 85.00%

=== 方向统计 ===
正向匹配 (sep1_fwd + sep2_fwd): 45000
反向匹配 (sep1_rc + sep2_rc): 25000
混合匹配1 (sep1_fwd + sep2_rc): 10000
混合匹配2 (sep1_rc + sep2_fwd): 5000

=== 配对验证 ===
R1文件reads数 = R2文件reads数: True ✓
```

### 目录结构示例
```
output_dir/
├── sample_R1.fq.gz        # 85000 paired reads
├── sample_R2.fq.gz        # 85000 paired reads  
└── sample_discarded.fq.gz # 15000 discarded reads
```

## 性能优化建议

### 分隔符设计
- 使用足够长且特异性强的分隔符序列（建议≥10bp）
- 避免在目标序列中出现的常见motif
- 考虑GC含量平衡

### 处理效率
- 将输入文件放在SSD硬盘上
- 为大文件预留足够的磁盘空间
- 监控内存使用情况

### 质量控制
- 根据实际数据调整`--min-length`参数
- 检查丢弃率，如果过高需要优化分隔符
- 验证输出的R1/R2配对正确性

## 注意事项

⚠️ **重要提醒**：

1. **序列方向**：脚本会自动处理序列的正向和反向互补匹配
2. **大小写敏感**：输入的分隔符会自动转换为大写进行匹配
3. **配对保证**：输出的R1和R2文件中的reads数量严格相等且一一对应
4. **质量分数**：质量分数会随序列一起正确分割
5. **内存使用**：大文件处理时注意内存使用情况

## 故障排除

### 常见问题

1. **配对成功率过低**：
   ```bash
   # 检查分隔符是否正确
   # 降低最小长度要求
   python S2_Split.py -i input.fq.gz -o output --min-length 5
   ```

2. **找不到分隔符**：
   ```bash
   # 检查序列方向，可能需要反向互补
   # 验证分隔符序列的正确性
   ```

3. **输出文件为空**：
   ```bash
   # 检查输入文件格式是否正确
   # 确认分隔符在序列中确实存在
   ```

4. **内存不足**：
   ```bash
   # 对于超大文件，考虑分批处理
   # 确保有足够的可用内存
   ```

### 调试建议

1. **查看统计输出**：分析方向统计了解数据特征
2. **检查丢弃文件**：分析被丢弃的reads找出问题
3. **验证分隔符**：在小数据集上测试分隔符的有效性
4. **长度分布**：检查分割后序列的长度分布

## 技术细节

### 算法流程
1. **序列预处理**：计算分隔符的反向互补序列
2. **模式搜索**：在每个read中搜索所有可能的分隔符组合
3. **最佳匹配**：选择产生最短R2序列的匹配（通常更可靠）
4. **质量过滤**：应用长度阈值过滤
5. **配对输出**：同步写入R1和R2文件确保配对

### 容错处理
- 跳过格式错误的FASTQ记录
- 优雅处理文件读取错误
- 提供详细的错误信息和警告

## 版本信息

- 脚本版本：最新版本
- 编码：UTF-8
- 兼容性：Linux/macOS/Windows
- 测试环境：Python 3.6+

## 扩展功能建议

可以考虑的未来改进：
- 支持多线程并行处理
- 添加HTML格式的统计报告
- 支持更复杂的分隔符模式
- 集成质量控制图表

## 联系方式

如有问题或建议，请联系开发团队。

---

💡 **提示**：首次使用建议在小数据集上测试，确认分隔符和参数设置正确后再处理完整数据。 
