# S3_process_sequences_count.sh 使用说明

## 简介

`S3_process_sequences_count.sh` 是一个高效的Bash脚本，专门用于在大量gzip压缩的序列文件中搜索和统计指定序列模式的出现情况。该脚本支持正向序列和反向互补序列的同时匹配，并提供并行处理能力以显著提高处理速度。

## 主要功能

- 🔍 **序列模式搜索**：同时搜索多个指定序列的共现情况
- 🧬 **反向互补分析**：自动计算并统计反向互补序列匹配
- ⚡ **并行处理**：支持多核并行处理，大幅提升效率
- 📊 **统计分析**：提供详细的匹配统计和百分比计算
- 📁 **批量处理**：一次性处理多个gzip压缩文件
- 🎯 **灵活配置**：支持自定义处理行数、输出路径等参数
- 📈 **实时输出**：处理结果同时显示在屏幕和文件中

## 应用场景

- **测序数据质控**：检查特定序列motif在测序数据中的分布
- **引物/探针验证**：统计PCR引物或杂交探针的匹配情况
- **序列特征分析**：分析特定DNA/RNA序列特征的出现频率
- **数据预处理**：为下游分析准备序列统计信息
- **批量质量评估**：对多个样本进行统一的序列质量评估

## 系统要求

### 操作系统
- Linux/Unix系统（推荐）
- macOS（兼容）
- Windows WSL（支持）

### 依赖软件
```bash
# 必需的系统工具（通常已预装）
- bash (版本 4.0+)
- gzip/zcat
- grep
- awk
- wc
- head
- sort
- tee

# 可选工具（用于获取CPU核心数）
- nproc (Linux)
```

## 安装

```bash
# 下载脚本文件
# 确保脚本具有执行权限
chmod +x S3_process_sequences_count.sh
```

## 使用方法

### 基本语法
```bash
./S3_process_sequences_count.sh -p "序列1,序列2,..." [其他选项]
```

### 参数说明

#### 必需参数
| 参数 | 说明 |
|------|------|
| `-p <序列列表>` | **必需**，逗号分隔的多个原始搜索序列 |

#### 可选参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `-d <描述>` | "未说明序列名字" | 序列组合的描述性名称 |
| `-i <输入模式>` | "*gz" | 输入.gz文件的匹配模式 |
| `-o <输出文件>` | 自动生成 | 输出TSV文件的路径和名称 |
| `-N <行数>` | 100000 | 每个文件处理的行数 |
| `-j <任务数>` | CPU核心数 | 并行处理的最大任务数 |
| `-h` | - | 显示帮助信息 |

## 工作原理

### 分析流程
```
输入文件 → 并行处理 → 序列搜索 → 统计计算 → 结果输出
    ↓           ↓           ↓           ↓           ↓
 *.gz文件   多任务处理   正向+反向    行数/百分比   TSV表格
```

### 匹配逻辑
1. **正向匹配**：搜索所有指定序列在同一行中的共现
2. **反向互补匹配**：搜索所有指定序列的反向互补序列在同一行中的共现
3. **统计计算**：分别计算两种匹配模式的行数和百分比

### 并行处理机制
- 每个输入文件作为一个独立任务
- 同时运行的任务数受`-j`参数限制
- 自动管理任务队列，确保系统资源合理利用

## 使用示例

### 基础使用
```bash
# 搜索两个序列的共现情况
./S3_process_sequences_count.sh -p "ATCGATCG,GCTAGCTA"
```

### 高级配置
```bash
# 完整参数配置
./S3_process_sequences_count.sh \
    -p "ATCGATCG,GCTAGCTA,TTAATTAA" \
    -d "三序列组合分析" \
    -i "sample_*.fastq.gz" \
    -o "results/analysis_results.tsv" \
    -N 200000 \
    -j 8
```

### 处理所有行
```bash
# 处理每个文件的所有行（不限制行数）
./S3_process_sequences_count.sh \
    -p "ATCGATCG,GCTAGCTA" \
    -N all \
    -d "全文件分析"
```

### 自定义输出目录
```bash
# 指定自定义输出路径
./S3_process_sequences_count.sh \
    -p "ATCGATCG" \
    -o "/path/to/custom/output.tsv"
```

### 批量处理特定文件
```bash
# 只处理特定模式的文件
./S3_process_sequences_count.sh \
    -p "ATCGATCG,GCTAGCTA" \
    -i "experiment_*_R1.fastq.gz" \
    -d "R1文件分析"
```

## 输出说明

### TSV文件格式
输出的TSV文件包含以下列：

| 列名 | 说明 |
|------|------|
| 样本 | 文件名（去除.gz扩展名） |
| 序列描述 | 用户提供的描述性名称 |
| 查询序列组合 | 搜索的序列列表 |
| 全正向共现行数 | 所有正向序列共同出现的行数 |
| 全反向互补共现行数 | 所有反向互补序列共同出现的行数 |
| 总处理Reads数 | 处理的总reads数量（行数÷4） |
| 全正向比例(%) | 正向匹配的百分比 |
| 全反向互补比例(%) | 反向互补匹配的百分比 |

### 输出示例
```
样本	序列描述	查询序列组合	全正向共现行数	全反向互补共现行数	总处理Reads数	全正向比例(%)	全反向互补比例(%)
sample1.fastq	测试序列组合	ATCGATCG,GCTAGCTA	1250	890	25000	5.00%	3.56%
sample2.fastq	测试序列组合	ATCGATCG,GCTAGCTA	1100	950	25000	4.40%	3.80%
sample3.fastq	测试序列组合	ATCGATCG,GCTAGCTA	1350	820	25000	5.40%	3.28%
```

### 目录结构
```
工作目录/
├── CountFold/                           # 默认输出目录
│   └── YYYYMMDD_HHMMSS_序列摘要_m行数.tsv  # 自动生成的结果文件
├── sample1.fastq.gz                    # 输入文件
├── sample2.fastq.gz
└── sample3.fastq.gz
```

## 性能优化建议

### 硬件配置
- **CPU**：多核处理器，推荐8核以上
- **内存**：建议8GB以上，大文件处理需要更多内存
- **存储**：SSD硬盘可显著提升I/O性能

### 参数调优
```bash
# 根据系统配置调整并行任务数
-j 4    # 4核CPU
-j 8    # 8核CPU
-j 16   # 16核CPU

# 根据内存限制调整处理行数
-N 50000    # 内存较小时
-N 200000   # 内存充足时
-N all      # 内存很充足时
```

### 文件组织
- 将输入文件放在SSD硬盘上
- 输出目录使用快速存储设备
- 避免在网络存储上进行密集I/O操作

## 注意事项

⚠️ **重要提醒**：

1. **序列格式**：输入序列自动转换为大写进行匹配
2. **文件格式**：只处理gzip压缩的文件(.gz结尾)
3. **共现要求**：只有当一行中包含**所有**指定序列时才计为匹配
4. **反向互补**：自动计算，无需手动提供
5. **并行安全**：脚本设计为多任务安全，不会产生竞争条件

### 资源管理
- 监控系统内存使用情况
- 大文件处理时适当降低并行任务数
- 确保有足够的磁盘空间存储结果

## 故障排除

### 常见问题

1. **脚本无法执行**：
   ```bash
   # 检查执行权限
   chmod +x S3_process_sequences_count.sh
   
   # 检查bash版本
   bash --version
   ```

2. **找不到输入文件**：
   ```bash
   # 检查文件匹配模式
   ls *.gz
   
   # 使用绝对路径
   ./script.sh -p "ATCG" -i "/full/path/to/*.gz"
   ```

3. **处理速度过慢**：
   ```bash
   # 增加并行任务数
   ./script.sh -p "ATCG" -j 16
   
   # 减少处理行数进行测试
   ./script.sh -p "ATCG" -N 10000
   ```

4. **内存不足**：
   ```bash
   # 减少并行任务数
   ./script.sh -p "ATCG" -j 2
   
   # 限制处理行数
   ./script.sh -p "ATCG" -N 50000
   ```

5. **输出目录权限错误**：
   ```bash
   # 检查目录权限
   ls -ld CountFold/
   
   # 创建输出目录
   mkdir -p CountFold
   chmod 755 CountFold
   ```

### 调试技巧

1. **小数据集测试**：
   ```bash
   # 先用少量行数测试
   ./script.sh -p "ATCG" -N 1000
   ```

2. **单文件测试**：
   ```bash
   # 指定单个文件进行测试
   ./script.sh -p "ATCG" -i "specific_file.gz"
   ```

3. **检查中间结果**：
   ```bash
   # 手动验证grep命令
   zcat sample.gz | head -1000 | grep "ATCG" | wc -l
   ```

## 性能基准

### 处理速度参考
- **小文件** (1GB)：约2-5分钟
- **中等文件** (5GB)：约10-20分钟  
- **大文件** (20GB)：约30-60分钟

*注：具体时间取决于硬件配置、序列复杂度和并行任务数*

### 资源消耗
- **CPU使用率**：接近100%（并行处理时）
- **内存使用**：通常<2GB（取决于处理行数）
- **磁盘I/O**：主要为读取操作，写入量较小

## 高级用法

### 与其他工具结合
```bash
# 结合find命令处理特定目录
find /data/sequences/ -name "*.gz" -exec \
  ./S3_process_sequences_count.sh -p "ATCG" -i {} \;

# 结合awk进行后处理
./S3_process_sequences_count.sh -p "ATCG" | awk -F'\t' '$4 > 1000 {print $1, $4}'
```

### 批处理脚本示例
```bash
#!/bin/bash
# 批量处理多个序列组合

sequences=(
    "ATCGATCG,GCTAGCTA"
    "TTAATTAA,CCGGCCGG"  
    "GGAATTCC,AATTGGCC"
)

for seq in "${sequences[@]}"; do
    echo "处理序列组合: $seq"
    ./S3_process_sequences_count.sh \
        -p "$seq" \
        -d "批量分析_$(echo $seq | tr ',' '_')" \
        -o "results/batch_$(echo $seq | tr ',' '_').tsv"
done
```

## 版本信息

- **脚本版本**：v20250528
- **兼容性**：Bash 4.0+
- **测试环境**：
  - Ubuntu 18.04/20.04/22.04
  - CentOS 7/8
  - macOS 10.15+

## 更新日志

- **v20250528**：当前版本，支持并行处理和详细统计
- 改进了内存管理和错误处理
- 增加了灵活的输出选项

## 联系方式

如有问题或建议，请联系开发团队。

---

💡 **提示**：建议在生产环境使用前，先在小数据集上测试脚本参数，确保结果符合预期。 